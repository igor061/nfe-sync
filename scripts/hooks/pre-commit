#!/usr/bin/env bash
# Incrementa versao patch e atualiza CHANGELOG.md a cada commit
# Le a mensagem do commit via linha de comando do processo pai

FILE="pyproject.toml"
CHANGELOG="CHANGELOG.md"

# le versao atual
current=$(grep '^version = ' "$FILE" | sed 's/version = "\(.*\)"/\1/')
if [ -z "$current" ]; then
  exit 0
fi

major=$(echo "$current" | cut -d. -f1)
minor=$(echo "$current" | cut -d. -f2)
patch=$(echo "$current" | cut -d. -f3)

new_patch=$((patch + 1))
new_version="${major}.${minor}.${new_patch}"

# atualiza pyproject.toml
sed -i '' "s/^version = \"${current}\"/version = \"${new_version}\"/" "$FILE"

# le mensagem do commit via linha de comando do processo pai (git commit -m "...")
commit_msg=$(ps -p $PPID -o args= 2>/dev/null | sed 's/.*[[:space:]]-m[[:space:]]*//' | head -1)

# insere nova entrada logo apos o header "# Changelog"
tmp=$(mktemp)
inserted=false
while IFS= read -r linha; do
  echo "$linha" >> "$tmp"
  if [ "$inserted" = false ] && echo "$linha" | grep -q "^# Changelog"; then
    echo "" >> "$tmp"
    echo "## ${new_version}" >> "$tmp"
    if [ -n "$commit_msg" ]; then
      echo "- ${commit_msg}" >> "$tmp"
    fi
    inserted=true
  fi
done < "$CHANGELOG"
mv "$tmp" "$CHANGELOG"

git add "$FILE" "$CHANGELOG"

echo "Versao atualizada: ${current} â†’ ${new_version}"
